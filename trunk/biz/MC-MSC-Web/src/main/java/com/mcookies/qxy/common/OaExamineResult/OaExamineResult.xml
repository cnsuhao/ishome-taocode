<?xml version='1.0' encoding='UTF-8' ?> 
<!DOCTYPE mapper
    PUBLIC '-//mybatis.org//DTD Dao 3.0//EN' 
    'http://mybatis.org/dtd/mybatis-3-mapper.dtd' >
<!-- OA审批结果表 -->
<!-- 需要和DAO保持完全路径一致 -->
<mapper namespace='com.mcookies.qxy.common.OaExamineResult.OaExamineResultDao'>
	<!-- 表字段信息 -->
	<sql id='tableColumns'>
		id,sid,tid,approval_information_id,oarule_id,oarule_status,result,time,content,is_use,create_time,creator,update_time,updator
	</sql>

	<!-- 根据条件更新所有记录 -->
	<update id='doUpdateAll' parameterType='OaExamineResultDBO'>
		UPDATE oa_examine_result SET update_time = #{updateTime} <!-- 更新时间、更新者 -->
		<if test=" id != null "><!-- 自增id -->
			,id = #{id}
		</if>
		<if test=" sid != null "><!-- 学校id -->
			,sid = #{sid}
		</if>
		<if test=" tid != null "><!-- 审核人id -->
			,tid = #{tid}
		</if>
		<if test=" approvalInformationId != null "><!-- 审核信息id -->
			,approval_information_id = #{approvalInformationId}
		</if>
		<if test=" oaruleId != null "><!-- 规则id -->
			,oarule_id = #{oaruleId}
		</if>
		<if test=" oaruleStatus != null "><!-- 规则状态 -->
			,oarule_status = #{oaruleStatus}
		</if>
		<if test=" result != null "><!-- 审核结果 -->
			,result = #{result}
		</if>
		<if test=" time != null "><!-- 审核时间 -->
			,time = #{time}
		</if>
		<if test=" content != null "><!-- 审核意见 -->
			,content = #{content}
		</if>
		<if test=" isUse != null "><!-- 是否启用 -->
			,is_use = #{isUse}
		</if>
		<if test=" createTime != null "><!-- 创建时间 -->
			,create_time = #{createTime}
		</if>
		<if test=" creator != null "><!-- 创建者 -->
			,creator = #{creator}
		</if>
		<if test=" updator != null "><!-- 最后更新者 -->
			,updator = #{updator}
		</if>
		WHERE 1 = 1
		<if test=" id != null "><!-- 自增id -->
			AND id = #{id}
		</if>
		<if test=" sid != null "><!-- 学校id -->
			AND sid = #{sid}
		</if>
		<if test=" tid != null "><!-- 审核人id -->
			AND tid = #{tid}
		</if>
		<if test=" approvalInformationId != null "><!-- 审核信息id -->
			AND approval_information_id = #{approvalInformationId}
		</if>
		<if test=" oaruleId != null "><!-- 规则id -->
			AND oarule_id = #{oaruleId}
		</if>
		<if test=" oaruleStatus != null "><!-- 规则状态 -->
			AND oarule_status = #{oaruleStatus}
		</if>
		<if test=" result != null "><!-- 审核结果 -->
			AND result = #{result}
		</if>
		<if test=" time != null "><!-- 审核时间 -->
			AND time = #{time}
		</if>
		<if test=" content != null "><!-- 审核意见 -->
			AND content = #{content}
		</if>
		<if test=" isUse != null "><!-- 是否启用 -->
			AND is_use = #{isUse}
		</if>
		<if test=" createTime != null "><!-- 创建时间 -->
			AND create_time = #{createTime}
		</if>
		<if test=" creator != null "><!-- 创建者 -->
			AND creator = #{creator}
		</if>
		<if test=" updateTime != null "><!-- 更新时间 -->
			AND update_time = #{updateTime}
		</if>
		<if test=" updator != null "><!-- 最后更新者 -->
			AND updator = #{updator}
		</if>
	</update>
	<!-- 查询分页数据信息 -->
	<select id='doSelectPage'
		parameterType='com.mcookies.qxy.common.OaExamineResult.OaExamineResultDBO'
		resultType='com.mcookies.qxy.common.OaExamineResult.OaExamineResultPVO'>
		SELECT
		<include refid='tableColumns' />
		FROM oa_examine_result
		WHERE 1 = 1
		<if test=" id != null "><!-- 自增id -->
			AND id = #{id}
		</if>
		<if test=" sid != null "><!-- 学校id -->
			AND sid = #{sid}
		</if>
		<if test=" tid != null "><!-- 审核人id -->
			AND tid = #{tid}
		</if>
		<if test=" approvalInformationId != null "><!-- 审核信息id -->
			AND approval_information_id = #{approvalInformationId}
		</if>
		<if test=" oaruleId != null "><!-- 规则id -->
			AND oarule_id = #{oaruleId}
		</if>
		<if test=" oaruleStatus != null "><!-- 规则状态 -->
			AND oarule_status = #{oaruleStatus}
		</if>
		<if test=" result != null "><!-- 审核结果 -->
			AND result = #{result}
		</if>
		<if test=" time != null "><!-- 审核时间 -->
			AND time = #{time}
		</if>
		<if test=" content != null "><!-- 审核意见 -->
			AND content = #{content}
		</if>
		<if test=" isUse != null "><!-- 是否启用 -->
			AND is_use = #{isUse}
		</if>
		<if test=" createTime != null "><!-- 创建时间 -->
			AND create_time = #{createTime}
		</if>
		<if test=" creator != null "><!-- 创建者 -->
			AND creator = #{creator}
		</if>
		<if test=" updateTime != null "><!-- 更新时间 -->
			AND update_time = #{updateTime}
		</if>
		<if test=" updator != null "><!-- 最后更新者 -->
			AND updator = #{updator}
		</if>
	</select>

	<!-- 插入一条数据 -->
	<insert id='doInsert' parameterType='OaExamineResultDBO'>
		INSERT INTO oa_examine_result
		(
		<include refid='tableColumns' />
		)
		VALUES
		(
		#{id},#{sid},#{tid},#{approvalInformationId},#{oaruleId},#{oaruleStatus},#{result},#{time},#{content},#{isUse},#{createTime},#{creator},#{updateTime},#{updator}
		)
	</insert>
	<!-- 修改一条数据 -->
	<update id='doUpdate' parameterType='OaExamineResultDBO'>
		UPDATE oa_examine_result SET update_time = #{updateTime} <!-- 更新时间、更新者 -->
		<if test=" id != null "><!-- 自增id -->
			,id = #{id}
		</if>
		<if test=" sid != null "><!-- 学校id -->
			,sid = #{sid}
		</if>
		<if test=" tid != null "><!-- 审核人id -->
			,tid = #{tid}
		</if>
		<if test=" approvalInformationId != null "><!-- 审核信息id -->
			,approval_information_id = #{approvalInformationId}
		</if>
		<if test=" oaruleId != null "><!-- 规则id -->
			,oarule_id = #{oaruleId}
		</if>
		<if test=" oaruleStatus != null "><!-- 规则状态 -->
			,oarule_status = #{oaruleStatus}
		</if>
		<if test=" result != null "><!-- 审核结果 -->
			,result = #{result}
		</if>
		<if test=" time != null "><!-- 审核时间 -->
			,time = #{time}
		</if>
		<if test=" content != null "><!-- 审核意见 -->
			,content = #{content}
		</if>
		<if test=" isUse != null "><!-- 是否启用 -->
			,is_use = #{isUse}
		</if>
		<if test=" createTime != null "><!-- 创建时间 -->
			,create_time = #{createTime}
		</if>
		<if test=" creator != null "><!-- 创建者 -->
			,creator = #{creator}
		</if>
		<if test=" updator != null "><!-- 最后更新者 -->
			,updator = #{updator}
		</if>
		WHERE 1 = 1
		<if test=" id != null "><!-- 自增id -->
			AND id = #{id}
		</if>
	</update>
	<!-- 逻辑删除一条数据 -->
	<delete id='toDelete' parameterType='OaExamineResultDBO'>
		UPDATE oa_examine_result SET ddd='1', update_time = #{updateTime}, uu2
		= #{uu2} WHERE update_time = #{updateTime}
		<if test=" id != null "><!-- 自增id -->
			AND id = #{id}
		</if>
	</delete>
	<!-- 物理删除一条数据 -->
	<delete id='doDelete' parameterType='OaExamineResultDBO'>
		DELETE FROM oa_examine_result WHERE update_time = #{updateTime}
		<if test=" id != null "><!-- 自增id -->
			AND id = #{id}
		</if>
	</delete>
	<!-- 查询一条数据 -->
	<select id='doRead' parameterType='OaExamineResultDBO'
		resultType='OaExamineResultDBO'>
		SELECT
		<include refid='tableColumns' />
		FROM oa_examine_result WHERE 1 = 1
		<if test=" id != null "><!-- 自增id -->
			AND id = #{id}
		</if>
	</select>
	<!-- 查询同一层还未审批的记录 -->
	<select id='doSelectUnChecked' parameterType='OaExamineResultDBO'
		resultType='OaExamineResultDBO'>
		SELECT
		<include refid='tableColumns' />
		FROM oa_examine_result
		WHERE approval_information_id =
		#{approvalInformationId}
		AND oarule_id = #{oaruleId}
		AND result = 0
	</select>
	<!-- 更新同一层的记录为相同状态（通过、拒绝） -->
	<update id='doUpdateSetStatus' parameterType='OaExamineResultDBO'>
		UPDATE
		oa_examine_result SET update_time = #{updateTime}, oarule_status =
		#{oaruleStatus}
		WHERE approval_information_id =
		#{approvalInformationId}
		AND oarule_id = #{oaruleId}
	</update>
	<!-- 根据提交事项id查询审批信息列表 -->
	<select id='findByApprovalInformationId'
		parameterType='com.mcookies.qxy.common.OaExamineInformation.OaExamineInformationPVO'
		resultType='com.mcookies.qxy.common.OaExamineResult.OaExamineResultPVO'>
		SELECT
		a.tid, a.oarule_status, a.result AS auditresult, a.content, b.teacher_name
		FROM oa_examine_result a
		LEFT JOIN u_teacher b ON a.tid = b.tid
		WHERE a.approval_information_id = #{approvalInformationId}
		<choose>
	        <when test="result == null or result == 0">
	            AND a.oarule_status = 0 AND a.result = 0
	        </when>
	        <when test="result == 2">
	            AND a.result = 0
	        </when>
	        <otherwise><!-- 审核通过，什么都不要 -->
	        	AND 1 > 2
	        </otherwise>
	    </choose>
	</select>
	
	
	<!-- 根据提交事项id查询审批信息列表 -->
	<select id='doSelectMyauditAndInfo'
		parameterType='OaExamineResultDBO'
		resultType='com.mcookies.qxy.common.OaExamineResult.OaExamineResultPVO'>
		SELECT distinct
		a.id, a.content, a.result, a.approval_information_id,a.oarule_status,c.type,c.content AS applyContent,c.create_time,e.oatags_id,e.oatags_name, a.tid,b.teacher_name
		FROM oa_examine_result a
		LEFT JOIN u_teacher b ON a.tid = b.tid
		LEFT JOIN oa_examine_information c ON a.approval_information_id = c.approval_information_id
		LEFT JOIN oa_rule d ON a.oarule_id = d.oarule_id
		LEFT JOIN oa_tags e ON d.oatags_id = e.oatags_id
		WHERE 1 = 1
		<if test=" id != null "><!-- 自增id -->
			AND id = #{id}
		</if>
	</select>


</mapper>
