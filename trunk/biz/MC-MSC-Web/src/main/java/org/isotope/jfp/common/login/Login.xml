<?xml version='1.0' encoding='UTF-8' ?> 
<!DOCTYPE mapper
    PUBLIC '-//mybatis.org//DTD Dao 3.0//EN' 
    'http://mybatis.org/dtd/mybatis-3-mapper.dtd' >
<!-- 角色功能权限 --> 
<!-- 需要和DAO保持完全路径一致 -->
<mapper namespace='org.isotope.jfp.common.login.LoginDao'>

    <!-- 用户登陆  -->
    <select id='readLoginer' parameterType='map' resultType='LoginerData'>
        SELECT 
            a.uid as puk
            ,a.password 
            ,0 as userType
        FROM user a
        WHERE 1=1
            <if test=" account != null "><!-- 登录账号 -->
                AND a.account = #{account}
            </if>
            <if test=" email != null "><!-- 登录邮箱 -->
                AND a.email = #{email}
            </if>
            <if test=" phone != null "><!-- 手机号 -->
                AND a.phone = #{phone}
            </if>
    </select>
    
    <select id='readTeacherLoginer' parameterType='map' resultType='LoginerData'>
        SELECT 
            u.tid as puk
            ,a.password 
            ,u.sid as schoolId
            ,u.teacher_name as userNameCN
            ,u.phone as userPhone
            ,u.gender
            ,u.id_type as isAdmin
            ,0 as userType
            ,s.school_name as schoolNameCN
            ,s.phone as schoolPhone
        FROM user a, u_teacher u,school s
        WHERE a.uid = u.uid  
            AND s.sid = u.sid 
            <if test=" account != null "><!-- 登录账号 -->
                AND a.account = #{account}
            </if>
            <if test=" email != null "><!-- 登录邮箱 -->
                AND a.email = #{email}
            </if>
            <if test=" phone != null "><!-- 手机号 -->
                AND a.phone = #{phone}
            </if>
            <if test=" openid != null "><!-- openid -->
                AND u.openid = #{openid}
            </if>
            <if test=" sid != null "><!-- 学校id -->
                AND u.sid = #{sid}
            </if>
            AND u.`status` = 1
            AND u.is_use = 1
    </select>
    <select id='readParentLoginer' parameterType='map' resultType='LoginerData'>
        SELECT 
             p.parent_id as puk
            ,a.uid as userId
            ,a.password 
              ,p.sid as schoolId
            ,p.parent_name as userNameCN
            ,p.phone as userPhone
            ,p.gender
            ,1 as userType
            ,s.school_name as schoolNameCN
            ,s.phone as schoolPhone
        FROM user a, u_parent p,school s
        WHERE a.uid = p.uid  
         	AND s.sid = p.sid 
            <if test=" account != null "><!-- 登录账号 -->
                AND a.account = #{account}
            </if>
            <if test=" email != null "><!-- 登录邮箱 -->
                AND a.email = #{email}
            </if>
            <if test=" phone != null "><!-- 手机号 -->
                AND a.phone = #{phone}
            </if>
            <if test=" openid != null "><!-- openid -->
                AND p.openid = #{openid}
            </if>
            <if test=" sid != null "><!-- 学校id -->
                AND p.sid = #{sid}
            </if>
            AND p.status = 1
            AND p.is_use = 1
    </select>
    <select id='readStudentLoginer' parameterType='map' resultType='LoginerData'>
        SELECT 
             t.student_id as puk
            ,a.uid as userId
            ,a.password 
            ,t.sid as schoolId
            ,t.student_name as userNameCN
            ,t.phone as userPhone
            ,t.gender
            ,2 as userType
            ,s.school_name as schoolNameCN
            ,s.phone as schoolPhone
        FROM user a, u_student t,school s
        WHERE a.uid = t.uid  
			AND s.sid = t.sid 
			<if test=" account != null "><!-- 登录账号 -->
                AND a.account = #{account}
            </if>
            <if test=" email != null "><!-- 登录邮箱 -->
                AND a.email = #{email}
            </if>
            <if test=" phone != null "><!-- 手机号 -->
                AND a.phone = #{phone}
            </if>
            <if test=" openid != null "><!-- openid -->
                AND t.openid = #{openid}
            </if>
            <if test=" sid != null "><!-- 学校id -->
                AND t.sid = #{sid}
            </if>
            AND t.status = 1
            AND t.is_use = 1
    </select>

    <!-- 插入一条数据 -->
    <insert id='creatLoginerByOpenId' parameterType='LoginerData' useGeneratedKeys="true" keyProperty="uid">
        INSERT INTO user
        (
            uid,account,create_time,creator,update_time,updator
        )
        VALUES
        (
            #{uid},#{account},#{createTime},#{creator},#{updateTime},#{updator}
        )
    </insert>

</mapper>
