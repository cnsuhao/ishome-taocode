<?xml version='1.0' encoding='UTF-8' ?> 
<!DOCTYPE mapper
    PUBLIC '-//mybatis.org//DTD Dao 3.0//EN' 
    'http://mybatis.org/dtd/mybatis-3-mapper.dtd' >
<!-- 抓取结果日志 -->
<!-- 需要和DAO保持完全路径一致 -->
<mapper namespace='com.upg.ceci.beans.CeciLog.CeciLogDao'>
    <!-- 表字段信息  -->
    <sql id='tableColumns'>
        id,area_code,log_date,area_name,page_no,process_num,process_num_success,info_type
    </sql>

    <!-- 插入一条数据 -->
    <insert id='doInsert' parameterType='CeciLogDBO'>
        INSERT INTO ceci_log
          ( <include refid='tableColumns'/>) 
        VALUES 
          ( #{id},#{areaCode},now(),#{areaName},#{pageNo},${processNum},${processNumSuccess},#{infoType} )
    </insert>
    
	<!-- 查询一条数据  -->
    <select id='doSelectPage' parameterType='CeciLogDBO' resultType='CeciLogDBO'>    	
        SELECT * 
		FROM (SELECT area_code,
		             MAX(CONVERT(page_no,SIGNED)) AS page_no,
		             SUM(process_num) AS process_num,
		             SUM(process_num_success) AS process_num_success,
		             MAX(log_date) AS log_date 
		      FROM ceci_log 
		      WHERE info_type = 'JOB_OK'
		      GROUP BY area_code) l
		ORDER BY log_date
    </select>
    
    <!-- 物理删除一条数据 -->
    <delete id='doDelete' parameterType='CeciLogDBO'>
        DELETE FROM ceci_log WHERE info_type = #{infoType}
    </delete>
    
    <!-- 查询一条数据  -->
    <select id='doRead' parameterType='CeciLogDBO' resultType='CeciLogDBO'>
        SELECT *
	    FROM (SELECT * ,process_num_success/process_num as per
			FROM (SELECT area_code,
					 MAX(CONVERT(page_no,SIGNED)) AS page_no,
					 SUM(process_num) AS process_num,
					 SUM(process_num_success) AS process_num_success,
					 MAX(log_date) AS log_date 
				FROM `ceci_log`
				WHERE info_type = 'JOB_OK'
				GROUP BY area_code) l
			ORDER BY per) c
	    WHERE area_code = #{areaCode}
    </select>
    <select id='doReadLast' parameterType='CeciLogDBO' resultType='CeciLogDBO'>
        SELECT <include refid='tableColumns'/> FROM ceci_log WHERE area_code = #{areaCode}
             AND info_type = 'JOB_COUNT' ORDER BY page_no DESC limit 1
    </select>
</mapper>
